#!/usr/bin/env lua
--[[ LIBRARY_MANAGER
--------------------------------------------------------------------------------
    Author:  Ed Higgins <ed.j.higgins@gmail.com>
--------------------------------------------------------------------------------
    Version: 0.1.1, 2025-04-05
--------------------------------------------------------------------------------
    This code is distributed under the MIT license.
----------------------------------------------------------------------------- ]]
local copas = require("copas")
local socket = require("socket")
local playm = require("lib/playback_manager")

local current_song = playm:new()
local filename = arg[1]

local function get_mime_type(file_path)
    local ext = file_path:match("^.+%.(.+)$")
    if ext == "html" then return "text/html"
    elseif ext == "css" then return "text/css"
    elseif ext == "js" then return "application/javascript"
    elseif ext == "json" then return "application/json"
    elseif ext == "png" then return "image/png"
    elseif ext == "jpg" or ext == "jpeg" then return "image/jpeg"
    elseif ext == "ico" then return "image/x-icon"
    else return "application/octet-stream"
    end
end


local function playback_task()
    while true do
        -- Only pump audio if we are in the PLAYING state
        if current_song.state == PLAYING then
            current_song:play()
        end
        -- Always sleep to keep the CPU cool and let the web server work
        copas.sleep(0.01)
    end
end

local function http_handler(skt)
    local line = skt:receive()
    if not line then return end

    local method, path = line:match("^(%u+)%s+(%S+)")
    
    -- Consume remaining headers
    while true do
        local header = skt:receive()
        if not header or header == "" then break end
    end

    if not method or not path then return end

    print(string.format("Request: %s %s", method, path))

    local status_code = 200
    local status_text = "OK"
    local content_type = "text/plain"
    local body = ""

    if method == "GET" then
        if path:match("^/api/") then
            if path == "/api/play" then
                if current_song.state == UNLOADED then
                    if filename then
                        current_song:load(filename)
                        current_song:start()
                    end
                elseif current_song.state == STOPPED then
                    current_song:start()
                else
                    current_song.state = PLAYING
                end
                body = "OK"

            elseif path == "/api/pause" then
                current_song:pause()
                body = "OK"

            elseif path == "/api/playpause" then
                if current_song.state == UNLOADED then
                    if filename then
                        current_song:load(filename)
                        current_song:start()
                    end
                elseif current_song.state == STOPPED then
                    current_song:start()

                elseif current_song.state == PLAYING then
                    current_song:pause()
                else
                    current_song.state = PLAYING
                end
                body = "OK"

            elseif path == "/api/stop" then
                current_song:stop()
                body = "OK"

            elseif path == "/api/status" then
                content_type = "application/json"
                local safe_filename = (current_song.filename or ""):gsub('"', '\\"')
                body = string.format('{"filename": "%s", "state": %d}', safe_filename, current_song.state)

            else
                status_code = 404
                status_text = "Not Found"
                body = "Not Found"

            end
        else
            -- Static File Serving
            -- Prevent directory traversal
            if path:match("%.%.") then
                status_code = 403
                status_text = "Forbidden"
                body = "Forbidden"
            else
                local serve_path = path
                -- Default to index.html if root is requested
                if serve_path == "/" then serve_path = "/index.html" end

                -- Construct local file path (relative to project root)
                local file_path = "data/web" .. serve_path

                local f = io.open(file_path, "rb")
                if f then
                    body = f:read("*a")
                    f:close()
                    content_type = get_mime_type(file_path)
                else
                    status_code = 404
                    status_text = "Not Found"
                    body = "404 Not Found: " .. file_path
                end
            end
        end
    else
        status_code = 405
        status_text = "Method Not Allowed"
        body = "Method Not Allowed"
    end

    -- Send HTTP Response
    skt:send(string.format("HTTP/1.1 %d %s\r\n", status_code, status_text))
    skt:send(string.format("Content-Type: %s\r\n", content_type))
    skt:send(string.format("Content-Length: %d\r\n", #body))
    skt:send("Connection: close\r\n")
    skt:send("\r\n")
    skt:send(body)
end

-- 3. Main Entry
function main()
    -- Create a server listening on all interfaces, port 8080
    local server = socket.bind("*", 8080)

    filename = arg[1]

    -- Tell Copas: "When 'server' gets a hit, run 'http_handler'"
    copas.addserver(server, http_handler)

    -- Add our music loop (as before)
    copas.addthread(playback_task)

    print("Server running on http://localhost:8080")
    copas.loop()
end

main()
